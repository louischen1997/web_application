AWSTemplateFormatVersion: "2010-09-09"
Description: CSYE 6225 
Parameters:
  VpcCidrBlock:
    Description: "CIDR block for VPC"
    Type: String
    Default: "10.0.0.0/16"
  Subnet1Cidr:
    Description: "subnet1 cidr"
    Type: String
    Default: "10.0.32.0/20"
  Subnet1ZN:
    Description: "subnet1 zone"
    Type: String
    Default: "us-west-2a"  
  Subnet2Cidr:
    Description: "subnet2 cidr"
    Type: String
    Default: "10.0.0.0/20"
  Subnet2ZN:
    Description: "subnet2 zone"
    Type: String
    Default: "us-west-2b"   
  Subnet3Cidr:
    Description: "subnet3 cidr"
    Type: String
    Default: "10.0.16.0/20"
  Subnet3ZN:
    Description: "subnet3 zone"
    Type: String
    Default: "us-west-2c"  
  ImageIdd:
    Description: "img id"
    Type: String 
    Default: "ami-0f425899fb7879df0"  
  Keynamestr:
    Description: "using key"      
    Type: String
    Default: "aws-us-west-2"
Resources:
  MyBucket:
    Type: "AWS::S3::Bucket"
    Properties: 
      BucketEncryption: 
        ServerSideEncryptionConfiguration: 
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
          
  myVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidrBlock
      EnableDnsSupport: 'true'
      EnableDnsHostnames: 'true'
      InstanceTenancy: 'default'
      Tags:
      - Key: Name
        Value: !Ref AWS::StackName
  mySubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: myVPC
      CidrBlock: !Ref Subnet1Cidr
      AvailabilityZone: !Ref Subnet1ZN
      MapPublicIpOnLaunch: 'true'
      Tags:
      - Key: Name
        Value: !Ref AWS::StackName
  mySubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: myVPC
      CidrBlock: !Ref Subnet2Cidr
      AvailabilityZone: !Ref Subnet2ZN
      Tags:
      - Key: Name
        Value: !Ref AWS::StackName
  mySubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: myVPC
      CidrBlock: !Ref Subnet3Cidr
      AvailabilityZone: !Ref Subnet3ZN
      Tags:
      - Key: Name
        Value: !Ref AWS::StackName            
  myInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
      - Key: stack
        Value: production
      - Key: Name
        Value: !Ref AWS::StackName   
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: myVPC
      InternetGatewayId:
        Ref: myInternetGateway    
  myRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:  
        Ref: myVPC
      Tags:
      - Key: stack
        Value: production
      - Key: Name
        Value: !Ref AWS::StackName        
  mySubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: mySubnet1
      RouteTableId:
        Ref: myRouteTable
  mySubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: mySubnet2
      RouteTableId:
        Ref: myRouteTable
  mySubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: mySubnet3
      RouteTableId:
        Ref: myRouteTable                  
  myRoute:
    Type: AWS::EC2::Route
    Properties:
       RouteTableId:
         Ref: myRouteTable
       DestinationCidrBlock: 0.0.0.0/0
       GatewayId:
         Ref: myInternetGateway
  privateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: myVPC
      CidrBlock: 10.0.160.0/20
      AvailabilityZone: "us-west-2a"
      Tags:
      - Key: Name
        Value: "private subnet1"
  privateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: myVPC
      CidrBlock: 10.0.128.0/20
      AvailabilityZone: "us-west-2b"
      Tags:
      - Key: Name
        Value: "private subnet2"
  privateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: myVPC
      CidrBlock: 10.0.144.0/20
      AvailabilityZone: "us-west-2c"
      Tags:
      - Key: Name
        Value: "private subnet3"   
  myPrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:  
        Ref: myVPC
      Tags:
      - Key: Name
        Value: "private route table"

  myPrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: privateSubnet1
      RouteTableId:
        Ref: myPrivateRouteTable
  myPrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: privateSubnet2
      RouteTableId:
        Ref: myPrivateRouteTable
  myPrivateSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: privateSubnet3
      RouteTableId:
        Ref: myPrivateRouteTable                                                
  MySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow http to client host
      VpcId: 
        Ref: myVPC
      Tags:
      - Key: Name
        Value: "application"  
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0   
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          CidrIp: 0.0.0.0/0
  privateInstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow http to client host
      VpcId: 
        Ref: myVPC
      Tags:
        - Key: Name
          Value: "database"  
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 0.0.0.0/0                            
  MyEC2Instance: 
    Type: AWS::EC2::Instance
    Properties: 
      ImageId: !Ref ImageIdd
      KeyName: !Ref Keynamestr
      InstanceType: "t2.micro"
      DisableApiTermination: 'false'
      UserData: 
        Fn::Base64:
          !Sub |
            #!/bin/bash
            apt-get -y install mysql-server
      SubnetId : 
        Ref: mySubnet1
      SecurityGroupIds: 
        - !Ref MySecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: "50"
            VolumeType: "gp2"
            DeleteOnTermination: 'true'
  myPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: myPrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      InstanceId: !Ref MyEC2Instance
  RDSDBParameterGroup:
    Type: 'AWS::RDS::DBParameterGroup'
    Properties:
      Description: CloudFormation Sample MySQL Parameter Group
      Family: mysql5.7
  myDBSubnetGroup: 
    Properties: 
      DBSubnetGroupDescription: description
      SubnetIds: 
        - !Ref privateSubnet1
        - !Ref privateSubnet2
        - !Ref privateSubnet3        
    Type: "AWS::RDS::DBSubnetGroup"    
  RDSDBInstance:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      AllocatedStorage: "50"
      DBInstanceClass: db.t3.micro
      MultiAZ : "false"
      DBInstanceIdentifier: 'csye6225'
      MasterUsername: 'csye6225'
      MasterUserPassword: 'LYtc$199796!_KkC25'
      Engine: 'mysql'
      DBSubnetGroupName:
        Ref: myDBSubnetGroup
      PubliclyAccessible: 'false' 
      DBName: "csye6225" 
      VPCSecurityGroups:
        - !Ref privateInstanceSecurityGroup
    
  
      
                     
       

Outputs:
    VpcId:
      Description: The VPC ID
      Value: !Ref myVPC
    SubnetId1:
      Description: The Subnet1 ID
      Value: !Ref mySubnet1
    SubnetId2:
      Description: The Subnet2 ID
      Value: !Ref mySubnet2
    SubnetId3:
      Description: The Subnet3 ID
      Value: !Ref mySubnet3
    Subnet1Zone:
      Description: The Subnet1 zone
      Value: !Ref Subnet1ZN
    Subnet2Zone:
      Description: The Subnet2 zone
      Value: !Ref Subnet2ZN     
    Subnet3Zone:
      Description: The Subnet3 zone
      Value: !Ref Subnet3ZN
    Subnet1Cidr:
      Description: The Subnet1 Cidr
      Value: !Ref Subnet1Cidr
    Subnet2Cidr:
      Description: The Subnet2 Cidr
      Value: !Ref Subnet2Cidr
    Subnet3Cidr:
      Description: The Subnet3 Cidr
      Value: !Ref Subnet3Cidr                          
